<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const downloadBtn = document.getElementById('downloadBtn');
  let img = null;
  let blindfoldImg = new Image();

  // Load the blindfold image with CORS
  blindfoldImg.src = 'https://mceal.github.io/BlindFoldApp/blindfold.png';
  blindfoldImg.setAttribute('crossorigin', 'anonymous'); // Add CORS for blindfold image

  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      img = new Image();
      img.setAttribute('crossorigin', 'anonymous'); // Add CORS for user-uploaded image
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.classList.remove('hidden');
        ctx.drawImage(img, 0, 0);
        updateBlindfold();
        downloadBtn.classList.remove('hidden');
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function updateBlindfold() {
    if (!img || !blindfoldImg.complete) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    const blindfoldX = parseInt(document.getElementById('blindfoldX').value) / 100 * canvas.width;
    const blindfoldY = parseInt(document.getElementById('blindfoldY').value) / 100 * canvas.height;
    const blindfoldHeight = parseInt(document.getElementById('blindfoldHeight').value) / 100 * canvas.height * 3;
    const blindfoldWidth = parseInt(document.getElementById('blindfoldWidth').value) / 100 * canvas.width * 3;
    const flip = document.getElementById('flipHorizontal').checked;

    const x = blindfoldX - blindfoldWidth / 2;

    ctx.save();
    if (flip) {
      ctx.scale(-1, 1);
      ctx.drawImage(blindfoldImg, -x - blindfoldWidth, blindfoldY - blindfoldHeight / 2, -blindfoldWidth, blindfoldHeight);
    } else {
      ctx.drawImage(blindfoldImg, x, blindfoldY - blindfoldHeight / 2, blindfoldWidth, blindfoldHeight);
    }
    ctx.restore();
  }

  function downloadImage() {
    const link = document.createElement('a');
    link.download = 'blindfolded-image.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }
</script>